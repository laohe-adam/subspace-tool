import csv
import time
import pandas
import schedule
from substrateinterface import SubstrateInterface

substrate = SubstrateInterface(url="wss://rpc-1.gemini-3h.subspace.network/ws")


def get_balance(wallet_address: str) -> float:
    """

    :param wallet_address:/ wallet
    :return:
    """

    try:
        result = substrate.query("System", "Account", [wallet_address])
        balance = result.value["data"]["free"] + result.value["data"]["reserved"]
        balance = round(balance / 10 ** substrate.properties.get('tokenDecimals', 0), 3)
        print(f' Balance  : {balance}  -  {wallet_address} ')
        return balance
    except:
        print(f'Erro with Get Balance,Maybe Close VPN or install and update your liabrary')


def push():
    try:
        # dingding push
        df = pandas.read_csv('balance_log.csv')
        df = df.T
    except:
        pass

def data_writer():
    try:
        df = pandas.read_csv('config.csv')
        # 时间戳
        t = time.time() * 1000
        balances = []
        balances.append(t)
        for address in df.address_s:
            balance = get_balance(address)
            balances.append(balance)
    
        # 前面是代币余额
        with open('balance_log.csv', 'a', newline='') as f:
            writer = csv.writer(f)
            writer.writerow(balances)
    except:
        pass

if __name__ == '__main__':
        schedule.every(3).minutes.do(data_writer)
        schedule.every(10).minutes.do(push())
    
        while True:
            schedule.run_pending()
            time.sleep(1)
